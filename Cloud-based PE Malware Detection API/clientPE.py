#!/usr/bin/env python

import boto3
import numpy as np
import argparse
import ast
from sklearn.preprocessing import RobustScaler

def main():
 
    import json
    import ember
    
    from sklearn.preprocessing import RobustScaler
    rs = RobustScaler()
       
    parser = argparse.ArgumentParser()
    parser.add_argument("-v", "--featureversion", type=int, default=2, help="EMBER feature version")
    parser.add_argument("binaries", metavar="BINARIES", type=str, nargs="+", help="PE files to classify")
    args = parser.parse_args()
    #opening the downloaded PE file
    testpe = open(args.binaries[0],'rb').read()
    #Feature extractor class of the ember project 
    extract = ember.PEFeatureExtractor() 
    data = extract.feature_vector(testpe) #vectorizing the extracted features
    scaled_data = rs.fit_transform([data])
    Xdata = np.reshape(scaled_data,(1, 2381))
    Xdata= Xdata.tolist()

    client = boto3.client('runtime.sagemaker',
				region_name='us-east-1',
                              	#enter ids from AWS CLI
				aws_access_key_id='ASIAQZ4QSJIHSDV6IM7U',
                aws_secret_access_key='aARtBkBhA9bmzqYTp+GZRuqvOrUTRaoPihWMkuJ0',
                aws_session_token='FwoGZXIvYXdzENr//////////wEaDHzHki0+crQSHpMrIiK0ARJX2uyQX/O/9jhcugg8U2bZDh8DwdjOgD+omMBH+LVc6n7PPZshZYD1S5HrtIKyYLM/i+nV0ycVvYBCb2ixrcAqzXB2tYN3UanhMtP9jXeqnA0QA3380/LV3IlLG820U0tDEBDYcBdABwYqxw3OTHrgHDThkOJ4nPknspF6EoE0sT2bsox34sILlAKxPDNaxUf/Q0cN0tESl40fYR5M3vTLtLGL71zJZyURAxgm7ajqX+BWrijSkaOLBjItJ7LszKG1n2d+drLVTgZiP8jKf/xZHMCqlIq9i7oGYk/6eMo3zscY6AsAlUqv'
)
    
    response = client.invoke_endpoint(EndpointName='sagemaker-tensorflow-serving-2021-10-14-00-07-15-516',ContentType='application/json' ,Body=json.dumps(Xdata))
    response_body = response['Body']
    out = response_body.read()
    astr = out.decode("UTF-8")
    out = ast.literal_eval(astr)
    print(out)
		
if __name__ == "__main__":
	main()
